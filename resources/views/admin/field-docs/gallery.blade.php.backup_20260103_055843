@extends('layouts.admin')

@section('title', 'Dokumentasi ' . ($shipment->awb_number ?: $shipment->bl_number ?: 'Shipment #'.$shipment->id))

@push('styles')
{{-- GLightbox CSS --}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css">
<style>
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    @media (max-width: 640px) {
        .photo-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
    }
    .photo-card {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 0.75rem;
        background: #f3f4f6;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .photo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .photo-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .photo-card:hover img {
        transform: scale(1.05);
    }
    .photo-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
        padding: 2rem 0.75rem 0.75rem;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .photo-card:hover .photo-overlay {
        opacity: 1;
    }
    .photo-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }
    .gslide-description {
        background: rgba(0,0,0,0.8) !important;
    }
</style>
@endpush

@section('content')
<div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    {{-- Header --}}
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    üì∏ Dokumentasi {{ $shipment->awb_number ?: $shipment->bl_number ?: 'Shipment #'.$shipment->id }}
                </h1>
                <p class="text-gray-500 mt-1">{{ $shipment->customer->company_name ?? 'N/A' }}</p>
                <div class="flex items-center gap-2 mt-2 flex-wrap">
                    <span class="text-xs px-2 py-1 rounded-full {{ $shipment->shipment_type === 'import' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700' }}">
                        {{ ucfirst($shipment->shipment_type ?? 'N/A') }}
                    </span>
                    <span class="text-xs text-gray-500">{{ $shipment->origin }} ‚Üí {{ $shipment->destination }}</span>
                </div>
            </div>
            
            {{-- Stats --}}
            <div class="flex items-center gap-4 text-sm">
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-gray-800">{{ $stats['total'] ?? 0 }}</span>
                    <span class="text-gray-500">üì∑ {{ $stats['total'] == 1 ? 'foto' : 'foto' }}</span>
                </div>
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-green-600">{{ $stats['with_location'] ?? 0 }}</span>
                    <span class="text-gray-500">üìç dengan GPS</span>
                </div>
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-blue-600">{{ $stats['today'] ?? 0 }}</span>
                    <span class="text-gray-500">üïê hari ini</span>
                </div>
            </div>
        </div>
        
        {{-- Action Buttons --}}
        <div class="flex flex-wrap gap-3 mt-6">
            <a href="{{ route('admin.field-docs.upload', $shipment->awb_number ?: $shipment->id) }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Tambah Foto
            </a>
            <a href="{{ route('admin.field-docs.qr', $shipment->awb_number ?: $shipment->id) }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                </svg>
                QR Code
            </a>
            <a href="{{ route('admin.field-docs.index') }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Kembali
            </a>
        </div>
    </div>

    {{-- Photo Gallery --}}
    @if($shipment->fieldPhotos && $shipment->fieldPhotos->count() > 0)
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Galeri Foto</h2>
            <p class="text-sm text-gray-500">Klik foto untuk melihat lebih besar</p>
        </div>
        
        <div class="photo-grid">
            @foreach($shipment->fieldPhotos as $index => $photo)
            <a href="{{ asset('storage/' . $photo->file_path) }}" 
               class="photo-card glightbox"
               data-gallery="gallery1"
               data-glightbox="title: {{ $photo->original_filename ?? 'Foto ' . ($index + 1) }}; description: {{ $photo->description ?: 'Diupload oleh ' . ($photo->user->name ?? 'Unknown') . ' pada ' . $photo->created_at->format('d/m/Y H:i') . ($photo->latitude ? ' ‚Ä¢ üìç GPS: ' . number_format($photo->latitude, 6) . ', ' . number_format($photo->longitude, 6) : '') }}">
                
                {{-- Thumbnail Image --}}
                <img src="{{ asset('storage/' . ($photo->thumbnail_path ?: $photo->file_path)) }}" 
                     alt="{{ $photo->original_filename ?? 'Photo' }}"
                     loading="lazy"
                     onerror="this.onerror=null; this.src='{{ asset('storage/' . $photo->file_path) }}';">
                
                {{-- Badges --}}
                <div class="photo-badge">
                    @if($photo->latitude && $photo->longitude)
                    <span class="px-1.5 py-0.5 bg-green-500 text-white text-xs rounded-full" title="GPS Location">
                        üìç
                    </span>
                    @endif
                    @if($photo->created_at->isToday())
                    <span class="px-1.5 py-0.5 bg-blue-500 text-white text-xs rounded-full">
                        Baru
                    </span>
                    @endif
                </div>
                
                {{-- Overlay Info --}}
                <div class="photo-overlay">
                    <p class="text-white text-sm font-medium truncate">{{ Str::limit($photo->original_filename ?? 'Photo', 25) }}</p>
                    <p class="text-gray-300 text-xs">{{ $photo->created_at->format('d/m/Y H:i') }}</p>
                    <p class="text-gray-300 text-xs flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                        {{ $photo->user->name ?? 'Unknown' }}
                    </p>
                </div>
            </a>
            @endforeach
        </div>
    </div>
    @else
    {{-- Empty State --}}
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Belum Ada Foto</h3>
        <p class="text-gray-500 mb-6">Shipment ini belum memiliki dokumentasi foto</p>
        <a href="{{ route('admin.field-docs.upload', $shipment->awb_number ?: $shipment->id) }}" 
           class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Upload Foto Pertama
        </a>
    </div>
    @endif
</div>
@endsection

@push('scripts')
{{-- GLightbox JS --}}
<script src="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize GLightbox
    const lightbox = GLightbox({
        selector: '.glightbox',
        touchNavigation: true,
        loop: true,
        autoplayVideos: false,
        preload: true,
        zoomable: true,
        draggable: true,
        dragToleranceX: 40,
        dragToleranceY: 65,
        openEffect: 'zoom',
        closeEffect: 'fade',
        slideEffect: 'slide',
        moreText: 'Lihat lebih',
        moreLength: 60,
        closeButton: true,
        touchFollowAxis: true,
        keyboardNavigation: true,
        closeOnOutsideClick: true,
        startAt: 0,
        plyr: {
            css: 'https://cdn.plyr.io/3.6.8/plyr.css',
            js: 'https://cdn.plyr.io/3.6.8/plyr.js',
        },
        skin: 'clean',
        svg: {
            close: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            next: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>',
            prev: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>',
        }
    });
    
    // Keyboard navigation info
    console.log('üì∑ GLightbox initialized. Use arrow keys to navigate, ESC to close.');
});
</script>
@endpush
