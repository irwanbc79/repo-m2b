@extends('layouts.admin')

@section('title', 'Dokumentasi ' . ($shipment->awb_number ?: $shipment->bl_number ?: 'Shipment #'.$shipment->id))

@push('styles')
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css">
<style>
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    @media (max-width: 640px) {
        .photo-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
    }
    .photo-card {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 0.75rem;
        background: #f3f4f6;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .photo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .photo-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .photo-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
        padding: 2rem 0.75rem 0.75rem;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .photo-card:hover .photo-overlay { opacity: 1; }
    .photo-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }
    .photo-delete-btn {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .photo-card:hover .photo-delete-btn { opacity: 1; }
    .photo-checkbox {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
    }
    .photo-card.selected {
        box-shadow: 0 0 0 3px #3b82f6;
    }
    /* GLightbox */
    .glightbox-container .gnext,
    .glightbox-container .gprev {
        width: 60px !important;
        height: 60px !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 50% !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
        opacity: 1 !important;
    }
    .glightbox-container .gprev { left: 20px !important; }
    .glightbox-container .gnext { right: 20px !important; }
    .glightbox-container .gclose {
        width: 50px !important;
        height: 50px !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 50% !important;
        top: 20px !important;
        right: 20px !important;
        opacity: 1 !important;
    }
</style>
@endpush

@section('content')
<div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    {{-- Flash Messages --}}
    @if(session('success'))
    <div class="mb-4 p-4 bg-green-100 text-green-700 rounded-lg">{{ session('success') }}</div>
    @endif

    {{-- Header --}}
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">
                    üì∏ Dokumentasi {{ $shipment->awb_number ?: $shipment->bl_number ?: 'Shipment #'.$shipment->id }}
                </h1>
                <p class="text-gray-500 mt-1">{{ $shipment->customer->company_name ?? 'N/A' }}</p>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-gray-800">{{ $stats['total'] ?? 0 }}</span>
                    <span class="text-gray-500">üì∑ foto</span>
                </div>
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-green-600">{{ $stats['with_location'] ?? 0 }}</span>
                    <span class="text-gray-500">üìç GPS</span>
                </div>
                <div class="text-center px-4 py-2 bg-gray-50 rounded-lg">
                    <span class="block text-2xl font-bold text-blue-600">{{ $stats['today'] ?? 0 }}</span>
                    <span class="text-gray-500">üïê hari ini</span>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-3 mt-6">
            <a href="{{ route('admin.field-docs.upload', $shipment->awb_number ?: $shipment->id) }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                ‚ûï Tambah Foto
            </a>
            <a href="{{ route('admin.field-docs.qr', $shipment->awb_number ?: $shipment->id) }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">
                üì± QR Code
            </a>
            @if($canDelete ?? false)
            <button type="button" id="bulk-delete-btn" onclick="bulkDeletePhotos()"
                    class="hidden items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                üóëÔ∏è <span id="bulk-delete-count">Hapus (0)</span>
            </button>
            <button type="button" id="toggle-select-btn" onclick="toggleSelectMode()"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-lg">
                ‚òëÔ∏è <span id="select-mode-text">Pilih Foto</span>
            </button>
            @endif
            <a href="{{ route('admin.field-docs.index') }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">
                ‚Üê Kembali
            </a>
        </div>
    </div>

    {{-- Gallery --}}
    @if($shipment->fieldPhotos && $shipment->fieldPhotos->count() > 0)
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Galeri Foto</h2>
            <p class="text-sm text-gray-500">Klik foto untuk melihat lebih besar</p>
        </div>
        
        <div class="photo-grid" id="photo-grid">
            @foreach($shipment->fieldPhotos as $index => $photo)
            @php
                $photoUrl = asset('storage/' . $photo->file_path);
                $thumbUrl = asset('storage/' . ($photo->thumbnail_path ?: $photo->file_path));
            @endphp
            
            <div class="photo-card" data-photo-id="{{ $photo->id }}">
                @if($canDelete ?? false)
                <div class="photo-checkbox hidden">
                    <input type="checkbox" class="photo-select-checkbox w-5 h-5 rounded" 
                           value="{{ $photo->id }}" onchange="updateSelectedCount()">
                </div>
                @endif
                
                <a href="{{ $photoUrl }}" class="glightbox block w-full h-full" data-gallery="gallery1"
                   data-glightbox="title: Foto {{ $index + 1 }}; description: {{ $photo->created_at->format('d/m/Y H:i') }} - {{ $photo->user->name ?? 'Unknown' }}">
                    <img src="{{ $thumbUrl }}" alt="Photo" loading="lazy" class="w-full h-full object-cover">
                </a>
                
                <div class="photo-badge">
                    @if($photo->latitude)
                    <span class="px-1.5 py-0.5 bg-green-500 text-white text-xs rounded-full">üìç</span>
                    @endif
                    @if($photo->created_at->isToday())
                    <span class="px-1.5 py-0.5 bg-blue-500 text-white text-xs rounded-full">Baru</span>
                    @endif
                </div>
                
                @if($canDelete ?? false)
                <button type="button" class="photo-delete-btn p-2 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg"
                        onclick="event.preventDefault(); event.stopPropagation(); deletePhoto({{ $photo->id }})"
                        title="Hapus foto">
                    üóëÔ∏è
                </button>
                @endif
                
                <div class="photo-overlay pointer-events-none">
                    <p class="text-white text-sm truncate">{{ $photo->original_filename ?? 'Photo' }}</p>
                    <p class="text-gray-300 text-xs">{{ $photo->created_at->format('d/m/Y H:i') }}</p>
                </div>
            </div>
            @endforeach
        </div>
    </div>
    @else
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <p class="text-gray-500 mb-4">Belum ada foto untuk shipment ini</p>
        <a href="{{ route('admin.field-docs.upload', $shipment->awb_number ?: $shipment->id) }}" 
           class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">
            ‚ûï Upload Foto Pertama
        </a>
    </div>
    @endif
</div>

{{-- Delete Modal --}}
<div id="delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">üóëÔ∏è</span>
            </div>
            <h3 class="text-lg font-semibold mb-2">Hapus Foto?</h3>
            <p class="text-gray-500 mb-6" id="delete-modal-message">Foto akan dihapus permanen.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                    Batal
                </button>
                <button id="confirm-delete-btn" onclick="confirmDelete()" 
                        class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script src="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js"></script>
<script>
// Init lightbox
document.addEventListener('DOMContentLoaded', function() {
    GLightbox({ selector: '.glightbox', loop: true });
});

let photoToDelete = null;
let isBulkDelete = false;
let isSelectMode = false;

function deletePhoto(photoId) {
    photoToDelete = photoId;
    isBulkDelete = false;
    document.getElementById('delete-modal-message').textContent = 'Foto akan dihapus permanen dan tidak dapat dikembalikan.';
    document.getElementById('delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    photoToDelete = null;
    isBulkDelete = false;
    // Reset button
    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = false;
    btn.textContent = 'Ya, Hapus';
}

function confirmDelete() {
    if (isBulkDelete) {
        executeBulkDelete();
        return;
    }
    
    if (!photoToDelete) return;
    
    // Get fresh CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (!csrfToken) {
        showToast('error', 'Session expired. Silakan refresh halaman.');
        closeDeleteModal();
        return;
    }
    
    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = true;
    btn.textContent = 'Menghapus...';
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    if (!csrfToken) {
        showToast('error', 'CSRF token tidak ditemukan');
        closeDeleteModal();
        return;
    }
    
    console.log('Deleting photo:', photoToDelete);
    
    fetch(`/admin/field-docs/photo/${photoToDelete}`, {
        method: 'DELETE',
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json().then(data => ({status: response.status, data: data}));
    })
    .then(({status, data}) => {
        console.log('Response data:', data);
        
        if (status === 200 && data.success) {
            const card = document.querySelector(`[data-photo-id="${photoToDelete}"]`);
            if (card) card.remove();
            showToast('success', data.message || 'Foto berhasil dihapus');
            
            if (document.querySelectorAll('.photo-card').length === 0) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showToast('error', data.message || 'Gagal menghapus foto');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showToast('error', 'Terjadi kesalahan jaringan');
    })
    .finally(() => {
        closeDeleteModal();
    });
}

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    document.querySelectorAll('.photo-checkbox').forEach(cb => cb.classList.toggle('hidden', !isSelectMode));
    
    const selectText = document.getElementById('select-mode-text');
    const bulkBtn = document.getElementById('bulk-delete-btn');
    
    if (isSelectMode) {
        selectText.textContent = 'Batal Pilih';
    } else {
        selectText.textContent = 'Pilih Foto';
        bulkBtn.classList.add('hidden');
        document.querySelectorAll('.photo-select-checkbox').forEach(cb => cb.checked = false);
        document.querySelectorAll('.photo-card').forEach(card => card.classList.remove('selected'));
    }
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.photo-select-checkbox:checked').length;
    const bulkBtn = document.getElementById('bulk-delete-btn');
    document.getElementById('bulk-delete-count').textContent = `Hapus (${selected})`;
    
    if (selected > 0) {
        bulkBtn.classList.remove('hidden');
        bulkBtn.classList.add('inline-flex');
    } else {
        bulkBtn.classList.add('hidden');
    }
    
    document.querySelectorAll('.photo-select-checkbox').forEach(cb => {
        cb.closest('.photo-card').classList.toggle('selected', cb.checked);
    });
}

function bulkDeletePhotos() {
    const selectedIds = Array.from(document.querySelectorAll('.photo-select-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length === 0) return;
    
    photoToDelete = selectedIds;
    isBulkDelete = true;
    document.getElementById('delete-modal-message').textContent = `Hapus ${selectedIds.length} foto? Tidak dapat dikembalikan.`;
    document.getElementById('delete-modal').classList.remove('hidden');
}

function executeBulkDelete() {
    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = true;
    btn.textContent = 'Menghapus...';
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    fetch('/admin/field-docs/photos/bulk-delete', {
        method: 'POST',
        headers: {
            'X-CSRF-TOKEN': csrfToken,
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ photo_ids: photoToDelete }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            photoToDelete.forEach(id => {
                const card = document.querySelector(`[data-photo-id="${id}"]`);
                if (card) card.remove();
            });
            showToast('success', data.message);
            toggleSelectMode();
            
            if (document.querySelectorAll('.photo-card').length === 0) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showToast('error', data.message || 'Gagal menghapus foto');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Terjadi kesalahan');
    })
    .finally(() => {
        closeDeleteModal();
    });
}

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
    toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}</span>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Close modal on ESC
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDeleteModal(); });
document.getElementById('delete-modal').addEventListener('click', e => { if (e.target.id === 'delete-modal') closeDeleteModal(); });
</script>
@endpush
