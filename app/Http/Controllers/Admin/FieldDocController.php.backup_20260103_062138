<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\FieldPhoto;
use App\Models\Shipment;
use Illuminate\Http\Request;
use SimpleSoftwareIO\QrCode\Facades\QrCode;

class FieldDocController extends Controller
{
    /**
     * Dashboard - Menampilkan statistik dan shipment terbaru
     */
    public function index()
    {
        $stats = [
            'today' => FieldPhoto::whereDate('created_at', today())->count(),
            'week' => FieldPhoto::whereBetween('created_at', [now()->startOfWeek(), now()->endOfWeek()])->count(),
            'total' => FieldPhoto::count(),
            'with_location' => FieldPhoto::whereNotNull('latitude')->count(),
        ];

        $recentShipments = Shipment::with(['customer', 'fieldPhotos'])
            ->whereHas('fieldPhotos')
            ->orderBy('updated_at', 'desc')
            ->limit(10)
            ->get();

        return view('admin.field-docs.index', compact('stats', 'recentShipments'));
    }

    /**
     * Upload - Halaman upload foto
     * @param string|null $shipment AWB/BL number atau ID shipment
     */
    public function upload(Request $request, $shipment = null)
    {
        $selectedShipment = null;
        
        if ($shipment) {
            // Cari shipment berdasarkan AWB, BL, atau ID
            $selectedShipment = Shipment::with('customer')
                ->where('awb_number', $shipment)
                ->orWhere('bl_number', $shipment)
                ->orWhere('id', $shipment)
                ->first();
        }

        return view('admin.field-docs.upload', [
            'shipment' => $selectedShipment,
            'shipmentNumber' => $selectedShipment ? ($selectedShipment->awb_number ?: $selectedShipment->bl_number ?: $selectedShipment->id) : null,
        ]);
    }

    /**
     * Mobile Upload - Halaman upload khusus mobile
     */
    public function mobileUpload($shipment = null)
    {
        $selectedShipment = null;
        
        if ($shipment) {
            $selectedShipment = Shipment::with('customer')
                ->where('awb_number', $shipment)
                ->orWhere('bl_number', $shipment)
                ->orWhere('id', $shipment)
                ->first();
        }

        return view('admin.field-docs.mobile-upload', [
            'shipment' => $selectedShipment,
            'shipmentNumber' => $selectedShipment ? ($selectedShipment->awb_number ?: $selectedShipment->bl_number ?: $selectedShipment->id) : null,
        ]);
    }

    /**
     * Gallery - Menampilkan foto-foto shipment
     */
    public function gallery($shipmentNumber)
    {
        $shipment = Shipment::with(['customer', 'fieldPhotos' => function($q) {
                $q->with('user')->orderBy('created_at', 'desc');
            }])
            ->where('awb_number', $shipmentNumber)
            ->orWhere('bl_number', $shipmentNumber)
            ->orWhere('id', $shipmentNumber)
            ->firstOrFail();

        $stats = [
            'total' => $shipment->fieldPhotos->count(),
            'with_location' => $shipment->fieldPhotos->whereNotNull('latitude')->count(),
            'today' => $shipment->fieldPhotos->where('created_at', '>=', today())->count(),
        ];

        return view('admin.field-docs.gallery', compact('shipment', 'stats'));
    }

    /**
     * QR Code - Menampilkan QR code untuk shipment
     */
    public function qrCode($shipmentNumber)
    {
        $shipment = Shipment::with('customer')
            ->where('awb_number', $shipmentNumber)
            ->orWhere('bl_number', $shipmentNumber)
            ->orWhere('id', $shipmentNumber)
            ->firstOrFail();

        return view('admin.field-docs.qr-code', compact('shipment'));
    }

    /**
     * Download QR - Download QR code sebagai SVG
     */
    public function downloadQr($shipmentNumber)
    {
        $shipment = Shipment::where('awb_number', $shipmentNumber)
            ->orWhere('bl_number', $shipmentNumber)
            ->orWhere('id', $shipmentNumber)
            ->firstOrFail();

        $identifier = $shipment->awb_number ?: $shipment->bl_number ?: $shipment->id;
        $uploadUrl = route('admin.field-docs.upload', $identifier);
        
        $qrCode = QrCode::size(300)
            ->format('svg')
            ->generate($uploadUrl);

        $filename = 'QR_' . $identifier . '.svg';

        return response($qrCode)
            ->header('Content-Type', 'image/svg+xml')
            ->header('Content-Disposition', 'attachment; filename="' . $filename . '"');
    }

    /**
     * Export PDF - Export foto sebagai PDF (placeholder)
     */
    public function exportPdf($shipmentNumber)
    {
        return redirect()->back()->with('info', 'Export PDF coming soon!');
    }

    /**
     * Search Shipments - API untuk mencari shipment
     */
    public function searchShipments(Request $request)
    {
        $query = $request->get('q', '');

        if (strlen($query) < 2) {
            return response()->json([]);
        }

        $shipments = Shipment::with('customer')
            ->where(function($q) use ($query) {
                $q->where('awb_number', 'LIKE', "%{$query}%")
                  ->orWhere('bl_number', 'LIKE', "%{$query}%")
                  ->orWhereHas('customer', function($cq) use ($query) {
                      $cq->where('company_name', 'LIKE', "%{$query}%");
                  });
            })
            ->orderBy('created_at', 'desc')
            ->limit(10)
            ->get();

        return response()->json($shipments->map(function($s) {
            return [
                'id' => $s->id,
                'awb_number' => $s->awb_number,
                'bl_number' => $s->bl_number,
                'customer_name' => $s->customer->company_name ?? 'N/A',
                'shipment_type' => $s->shipment_type,
                'origin' => $s->origin,
                'destination' => $s->destination,
            ];
        }));
    }
}
