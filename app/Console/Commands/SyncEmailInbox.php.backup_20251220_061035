<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Webklex\IMAP\Facades\Client;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;
use Illuminate\Support\Str;

class SyncEmailInbox extends Command
{
    protected $signature = 'email:sync {mailbox?}';
    protected $description = 'Sync IMAP inbox to database (incremental, safe)';

    protected array $mailboxes = ['sales', 'import', 'export'];

    public function handle()
    {
        $targetMailbox = $this->argument('mailbox');

        $mailboxes = $targetMailbox
            ? [$targetMailbox]
            : $this->mailboxes;

        foreach ($mailboxes as $mailbox) {
            $this->info("Syncing mailbox: {$mailbox}");
            $this->syncMailbox($mailbox);
        }

        $this->info('Email sync completed.');
        return Command::SUCCESS;
    }

    protected function syncMailbox(string $mailbox)
    {
        try {
            // Ambil UID terakhir
            $lastUid = DB::table('email_mailboxes')
                ->where('mailbox', $mailbox)
                ->value('last_uid') ?? 0;

            $client = Client::account($mailbox);
            $client->connect();

            $folder = $client->getFolder('INBOX');

            $messages = $folder->query()
                ->whereUidGreater($lastUid)
                ->limit(20) // HARD LIMIT (AMAN)
                ->get();

            foreach ($messages as $message) {
                DB::beginTransaction();

                try {
                    $uid = (int) $message->getUid();

                    // Cegah duplikasi
                    $exists = DB::table('emails')
                        ->where('mailbox', $mailbox)
                        ->where('uid', $uid)
                        ->exists();

                    if ($exists) {
                        DB::rollBack();
                        continue;
                    }

                    $from = $message->getFrom()[0]->mail ?? null;
                    $fromName = $message->getFrom()[0]->personal ?? $from;
                    $subject = (string) $message->getSubject();

                    $dateObj = $message->getDate();
                    $date = $dateObj instanceof Carbon
                        ? $dateObj
                        : Carbon::parse($dateObj->first());

                    // Simpan EMAIL
                    $emailId = DB::table('emails')->insertGetId([
                        'mailbox'   => $mailbox,
                        'uid'       => $uid,
                        'message_id'=> (string)$message->getMessageId(),
                        'subject'   => $subject,
                        'from_email'=> $from,
                        'from_name' => $fromName,
                        'body'      => $message->getTextBody() ?: null,
                        'is_read'   => $message->getFlags()->has('seen'),
                        'email_date'=> $date,
                        'created_at'=> now(),
                        'updated_at'=> now(),
                    ]);

                    // ATTACHMENTS (DOWNLOAD SEKALI)
                    foreach ($message->getAttachments() as $att) {
                        $filename = $att->getName();
                        $safeName = Str::slug(pathinfo($filename, PATHINFO_FILENAME));
                        $ext = pathinfo($filename, PATHINFO_EXTENSION) ?: 'bin';

                        $path = "email_attachments/{$mailbox}/{$uid}";
                        $fullPath = "{$path}/{$safeName}_" . uniqid() . ".{$ext}";

                        Storage::put($fullPath, $att->getContent());

                        DB::table('email_attachments')->insert([
                            'email_id' => $emailId,
                            'filename' => $filename,
                            'file_path'=> $fullPath,
                            'mime_type'=> $att->getMimeType(),
                            'file_size'=> $att->getSize(),
                            'created_at'=> now(),
                        ]);
                    }

                    // Update last UID
                    DB::table('email_mailboxes')->updateOrInsert(
                        ['mailbox' => $mailbox],
                        ['last_uid' => $uid, 'updated_at' => now()]
                    );

                    DB::commit();

                } catch (\Throwable $e) {
                    DB::rollBack();
                    Log::error("Email sync failed (UID {$uid})", [
                        'mailbox' => $mailbox,
                        'error' => $e->getMessage()
                    ]);
                }
            }

        } catch (\Throwable $e) {
            Log::error("IMAP sync error", [
                'mailbox' => $mailbox,
                'error' => $e->getMessage()
            ]);
        }
    }
}
