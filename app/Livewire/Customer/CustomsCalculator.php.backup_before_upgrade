<?php

namespace App\Livewire\Customer;

use Livewire\Component;
use App\Models\TaxExchangeRate;

class CustomsCalculator extends Component
{
    // Properti Input
    public $nilai_barang = 0;
    public $mata_uang = 'USD';
    public $kurs = 0; 
    public $is_auto_kurs = true;
    
    // Properti Tarif (%) - Standar Umum
    public $tarif_bm = 10;
    public $tarif_ppn = 11;
    public $tarif_ppnbm = 0;
    public $tarif_pph = 7.5;

    // Properti Hasil
    public $nilai_pabean = 0;
    public $bayar_bm = 0;
    public $nilai_impor = 0;
    public $bayar_ppn = 0;
    public $bayar_ppnbm = 0;
    public $bayar_pph = 0;
    public $total_pungutan = 0;

    public function mount()
    {
        $this->syncWithTaxRate();
        $this->hitung();
    }

    /**
     * Mengambil data kurs USD terbaru dari database agar sinkron dengan laman Kurs Pajak
     */
    public function syncWithTaxRate()
    {
        $usdData = TaxExchangeRate::where('currency_code', 'USD')->first();
        
        if ($usdData) {
            $this->kurs = (float) $usdData->rate;
            $this->is_auto_kurs = true;
        } else {
            $this->kurs = 16000; // Fallback jika data kosong
            $this->is_auto_kurs = false;
        }
    }

    public function updated($propertyName)
    {
        if ($propertyName === 'mata_uang') {
            if ($this->mata_uang === 'USD') {
                $this->syncWithTaxRate();
            } else {
                $this->is_auto_kurs = false;
                $this->kurs = 0; 
            }
        }
        $this->hitung();
    }

    public function hitung()
    {
        $val = (float)($this->nilai_barang ?? 0);
        $rate = (float)($this->kurs ?? 0);
        $tBM = (float)($this->tarif_bm ?? 0);
        $tPPN = (float)($this->tarif_ppn ?? 0);
        $tPPnBM = (float)($this->tarif_ppnbm ?? 0);
        $tPPh = (float)($this->tarif_pph ?? 0);

        // 1. Nilai Pabean (CIF IDR)
        $this->nilai_pabean = $val * $rate;

        // 2. Bea Masuk (Pembulatan ke bawah per ribuan)
        $bm_raw = $this->nilai_pabean * ($tBM / 100);
        $this->bayar_bm = floor($bm_raw / 1000) * 1000;

        // 3. Nilai Impor
        $this->nilai_impor = $this->nilai_pabean + $this->bayar_bm;

        // 4. Pajak Impor (PDRI) - Pembulatan ke bawah per ribuan
        $this->bayar_ppn = floor(($this->nilai_impor * ($tPPN / 100)) / 1000) * 1000;
        $this->bayar_ppnbm = floor(($this->nilai_impor * ($tPPnBM / 100)) / 1000) * 1000;
        $this->bayar_pph = floor(($this->nilai_impor * ($tPPh / 100)) / 1000) * 1000;

        // Total
        $this->total_pungutan = $this->bayar_bm + $this->bayar_ppn + $this->bayar_ppnbm + $this->bayar_pph;
    }

    public function resetCalculator()
    {
        $this->nilai_barang = 0;
        $this->syncWithTaxRate();
        $this->hitung();
    }

    public function render()
    {
        return view('livewire.customer.customs-calculator')->layout('layouts.customer');
    }
}