<?php

namespace App\Livewire\Admin;

use Livewire\Component;
use Livewire\WithPagination;
use Illuminate\Support\Facades\DB;
use App\Models\Shipment;
use App\Models\Customer;
use App\Models\Document;
use App\Models\User;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Str;

class EmailInbox extends Component
{
    use WithPagination;

    public $activeAccount = 'sales';
    public $mailboxes = ['sales', 'import', 'export'];

    public $emails = [];
    public $selectedEmail = null;
    public $showConvertModal = false;

    public $customer_id;
    public $service_type = 'import';
    public $shipment_type = 'sea';
    public $selectedAttachments = [];

    public function mount()
    {
        $this->activeAccount = 'sales';
        logger()->info('MOUNT CALLED!');
        $this->dispatch('alert', message: 'Component Mounted!');
        $this->loadEmails();
    }

    public function loadEmails()
    {
        $this->emails = DB::table('emails')
            ->where('mailbox', $this->activeAccount)
            ->orderByDesc('email_date')
            ->limit(20)
            ->get()
            ->map(function ($email) {
                $attachments = DB::table('email_attachments')
                    ->where('email_id', $email->id)
                    ->get()
                    ->map(function ($att) {
                        return [
                            'id' => $att->id,
                            'name' => $att->filename,
                            'size_raw' => $att->size,
                            'size' => $this->formatBytes($att->size),
                            'type' => $att->mime_type,
                            'path' => $att->file_path,
                        ];
                    })->toArray();

                return [
                    'db_id' => $email->id,
                    'uid' => $email->uid,
                    'subject' => $email->subject,
                    'from' => $email->from_email,
                    'name' => $email->from_name,
                    'date' => optional($email->email_date)->format('d M H:i'),
                    'body' => $email->body,
                    'is_read' => (bool)$email->is_read,
                    'attachments' => $attachments,
                ];
            })
            ->toArray();
    }

    public function switchAccount($account)
    {
        $this->activeAccount = $account;
        $this->selectedEmail = null;
        $this->loadEmails();
    }

    public function selectEmail($dbId)
    {
        logger()->info("=== selectEmail called
        logger()->info('showConvertModal before: ' . ($this->showConvertModal ? 'true' : 'false')); with dbId: $dbId");
        
        $email = DB::table('emails')->where('id', $dbId)->first();
        
        if (!$email) {
            logger()->error("Email not found for dbId: $dbId");
            return;
        }
        
        logger()->info("Email found: " . $email->subject);

        // Mark as read
        DB::table('emails')->where('id', $dbId)->update(['is_read' => true]);

        // Load attachments
        $attachments = DB::table('email_attachments')
            ->where('email_id', $email->id)
            ->get()
            ->map(function ($att) {
                $sizeRaw = $att->size ?? 0;
                $sizeMB = $sizeRaw > 0 ? round($sizeRaw / 1024 / 1024, 2) : 0;
                $sizeDisplay = $sizeMB > 0 ? $sizeMB . ' MB' : round($sizeRaw / 1024, 2) . ' KB';
                
                return [
                    'id' => $att->id,
                    'name' => $att->name,
                    'type' => $att->type ?? 'application/octet-stream',
                    'size_raw' => $sizeRaw,
                    'size' => $sizeDisplay,
                    'path' => $att->path ?? '',
                ];
            })
            ->toArray();

        // Build the selectedEmail array
        $this->selectedEmail = [
            'db_id' => $email->id,
            'uid' => $email->uid ?? '',
            'subject' => $email->subject ?? '(No Subject)',
            'from' => $email->from_email ?? '',
            'name' => $email->from_name ?? explode('@', $email->from_email ?? 'Unknown')[0],
            'date' => \Carbon\Carbon::parse($email->email_date)->format('d M Y H:i'),
            'body' => $email->body ?? '(No content)',
            'attachments' => $attachments,
        ];
        
        logger()->info("selectedEmail set successfully with " . count($attachments) . " attachments");
        logger()->info('showConvertModal after: ' . ($this->showConvertModal ? 'true' : 'false'));
        // Reload email list to update read status
        $this->loadEmails();
    }

    public function getUnreadCount($account)
    {
        return DB::table('emails')
            ->where('mailbox', $account)
            ->where('is_read', false)
            ->count();
    }

    public function openConvertModal()
    {
        $this->showConvertModal = true;
        $this->selectedAttachments = [];

        if (!$this->selectedEmail) return;

        $this->selectedAttachments = array_keys($this->selectedEmail['attachments']);

        $emailFrom = $this->selectedEmail['from'];
        $this->customer_id = null;

        $user = User::where('email', $emailFrom)->first();
        if ($user) {
            $cust = Customer::where('user_id', $user->id)->first();
            if ($cust) {
                $this->customer_id = $cust->id;
                return;
            }
        }

        $domain = explode('@', $emailFrom)[1] ?? '';
        $namePart = explode('.', $domain)[0];

        if (!in_array($namePart, ['gmail', 'yahoo', 'hotmail', 'outlook'])) {
            $cust = Customer::where('company_name', 'like', '%' . $namePart . '%')->first();
            if ($cust) $this->customer_id = $cust->id;
        }
    }

    public function closeConvertModal()
    {
        $this->showConvertModal = false;
    }

    public function convertToShipment()
    {
        $this->validate([
            'customer_id' => 'required',
            'service_type' => 'required',
            'shipment_type' => 'required',
        ]);

        DB::transaction(function () {
            $prefix = strtoupper(substr($this->service_type, 0, 3));
            $awb = $prefix . '-' . date('ymd') . '-' . rand(100, 999);

            $shipment = Shipment::create([
                'customer_id' => $this->customer_id,
                'awb_number' => $awb,
                'origin' => 'Email Conversion',
                'destination' => 'Indonesia',
                'service_type' => $this->service_type,
                'shipment_type' => $this->shipment_type,
                'status' => 'pending',
                'notes' => "Converted from email: " . $this->selectedEmail['subject']
            ]);

            $uploader = Auth::id() ?? 1;

            foreach ($this->selectedEmail['attachments'] as $idx => $att) {
                if (!in_array($idx, $this->selectedAttachments)) continue;

                Document::create([
                    'shipment_id' => $shipment->id,
                    'description' => 'Email Attachment: ' . $att['name'],
                    'file_path' => $att['path'],
                    'filename' => $att['name'],
                    'is_internal' => false,
                    'uploaded_by' => $uploader,
                    'file_size' => $att['size_raw'],
                    'mime_type' => $att['type'],
                    'uploaded_at' => now(),
                ]);
            }
        });

        session()->flash('message', 'Email berhasil dikonversi ke Shipment');
        return redirect()->route('admin.shipments.index');
    }

    private function formatBytes($bytes, $precision = 2)
    {
        $units = ['B', 'KB', 'MB', 'GB'];
        $bytes = max($bytes, 0);
        $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
        $pow = min($pow, count($units) - 1);
        return round($bytes / pow(1024, $pow), $precision) . ' ' . $units[$pow];
    }


    /**
     * Force refresh emails from IMAP
     */
    public function forceRefresh()
    {
        $this->loadEmails();
        session()->flash('message', 'Emails refreshed successfully!');
    }

    public function render()
    {
        $customers = Customer::orderBy('company_name')->get();

        return view('livewire.admin.email-inbox', [
            'customers' => $customers,
            'mailboxes' => $this->mailboxes,
            'emails' => $this->emails,
        ])->layout('layouts.admin');
    }

    public function testClick()
    {
        logger()->info('=== TEST CLICK WORKS ===');
        $this->dispatch('alert', message: 'Test Livewire berhasil!');
    }
}
