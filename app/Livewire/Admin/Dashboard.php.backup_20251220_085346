<?php

namespace App\Livewire\Admin;

use Livewire\Component;
use App\Models\Shipment;
use App\Models\Customer;
use App\Models\Invoice;

class Dashboard extends Component
{
    public function render()
    {
        // 1. Hitung Statistik
        $stats = [
            'total_shipments'     => Shipment::count(),
            'active_shipments'    => Shipment::whereIn('status', ['pending', 'in_progress', 'in_transit'])->count(),
            'completed_shipments' => Shipment::where('status', 'completed')->count(),
            
            // Hitung Customer ASLI (bukan staf)
            'total_customers'     => Customer::whereHas('user', function($q) {
                $q->where('role', 'customer');
            })->count(),
            
            // Invoice Belum Lunas
            'pending_invoices'    => Invoice::where('status', 'unpaid')->count(),
        ];

        // 2. Ambil Data Terbaru
        $recentShipments = Shipment::with('customer')
            ->latest()
            ->take(5)
            ->get();

        // 3. Kirim ke View
        return view('livewire.admin.dashboard', [
            'stats' => $stats, // Variabel ini yang dicari oleh Blade
            'recentShipments' => $recentShipments
        ])->layout('layouts.admin');
    }
}