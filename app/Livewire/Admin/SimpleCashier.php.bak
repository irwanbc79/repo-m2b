<?php

namespace App\Livewire\Admin;

use Livewire\Component;
use Livewire\WithFileUploads;
use App\Services\CashierService;
use App\Models\Customer;
use App\Models\Vendor;
use App\Models\Shipment;
use App\Models\Invoice;
use App\Models\VendorBill;
use App\Models\CashTransaction;
use Illuminate\Support\Facades\DB;

class SimpleCashier extends Component
{
    use WithFileUploads;
    
    // Form properties
    public $transaction_date;
    public $transaction_type = 'cash_in';
    public $counterpart_type = 'customer';
    public $counterpart_id;
    public $counterpart_name;
    public $shipment_id;
    public $cost_category = 'shipment';
    public $amount;
    public $currency = 'IDR';
    public $exchange_rate = 1;
    public $description;
    public $attachment;
    
    // Related data
    public $invoice_id;
    public $vendor_bill_id;
    
    // Selections (for dropdowns)
    public $customers = [];
    public $vendors = [];
    public $shipments = [];
    public $invoices = [];
    public $vendorBills = [];
    
    // Preview data (read-only)
    public $preview = null;
    
    // UI state
    public $showPreview = false;
    public $isSubmitting = false;
    
    // Recent transactions
    public $recentTransactions = [];
    
    protected $cashierService;
    
    public function boot(CashierService $cashierService)
    {
        $this->cashierService = $cashierService;
    }
    
    public function mount()
    {
        $this->transaction_date = now()->format('Y-m-d');
        $this->loadInitialData();
        $this->loadRecentTransactions();
    }
    
    /**
     * Load initial dropdown data
     */
    private function loadInitialData()
    {
        $this->customers = Customer::with('user')
            ->orderBy('company_name')
            ->get()
            ->map(fn($c) => [
                'id' => $c->id,
                'name' => $c->company_name,
                'code' => $c->customer_code,
            ])
            ->toArray();
            
        $this->vendors = Vendor::orderBy('name')
            ->get()
            ->map(fn($v) => [
                'id' => $v->id,
                'name' => $v->name,
                'code' => $v->code ?? '-',
            ])
            ->toArray();
    }
    
    /**
     * Load recent transactions for reference
     */
    private function loadRecentTransactions()
    {
        $this->recentTransactions = CashTransaction::with(['customer', 'vendor', 'shipment'])
            ->latest()
            ->take(10)
            ->get()
            ->toArray();
    }
    
    /**
     * When transaction type changes
     */
    public function updatedTransactionType()
    {
        // Reset form
        $this->resetCounterpart();
        $this->updatePreview();
    }
    
    /**
     * When counterpart type changes (customer/vendor)
     */
    public function updatedCounterpartType()
    {
        $this->resetCounterpart();
        $this->updatePreview();
    }
    
    /**
     * When counterpart selected
     */
    public function updatedCounterpartId()
    {
        if ($this->counterpart_type === 'customer' && $this->counterpart_id) {
            $customer = Customer::find($this->counterpart_id);
            if ($customer) {
                $this->counterpart_name = $customer->company_name;
                $this->loadCustomerShipments();
                $this->loadCustomerInvoices();
            }
        }
        
        if ($this->counterpart_type === 'vendor' && $this->counterpart_id) {
            $vendor = Vendor::find($this->counterpart_id);
            if ($vendor) {
                $this->counterpart_name = $vendor->name;
                $this->loadVendorShipments();
                $this->loadVendorBills();
            }
        }
        
        $this->updatePreview();
    }
    
    /**
     * When shipment selected
     */
    public function updatedShipmentId()
    {
        $this->updatePreview();
    }
    
    /**
     * When amount changes
     */
    public function updatedAmount()
    {
        $this->updatePreview();
    }
    
    /**
     * Load shipments for selected customer
     */
    private function loadCustomerShipments()
    {
        if (!$this->counterpart_id) {
            $this->shipments = [];
            return;
        }
        
        $customer = Customer::find($this->counterpart_id);
        if (!$customer) {
            $this->shipments = [];
            return;
        }
        
        $this->shipments = $customer->shipments()
            ->latest()
            ->take(20)
            ->get()
            ->map(fn($s) => [
                'id' => $s->id,
                'awb' => $s->awb_number,
                'route' => $s->origin . ' → ' . $s->destination,
                'status' => $s->status,
                'service' => $s->service_type,
            ])
            ->toArray();
    }
    
    /**
     * Load invoices for selected customer
     */
    private function loadCustomerInvoices()
    {
        if (!$this->counterpart_id) {
            $this->invoices = [];
            return;
        }
        
        $this->invoices = Invoice::where('customer_id', $this->counterpart_id)
            ->where('status', 'unpaid')
            ->latest()
            ->get()
            ->map(fn($i) => [
                'id' => $i->id,
                'number' => $i->invoice_number,
                'amount' => $i->total_amount,
                'date' => $i->invoice_date->format('d/m/Y'),
            ])
            ->toArray();
    }
    
    /**
     * Load shipments for selected vendor
     */
    private function loadVendorShipments()
    {
        if (!$this->counterpart_id) {
            $this->shipments = [];
            return;
        }
        
        // Get shipments yang ada job cost dari vendor ini
        $this->shipments = Shipment::whereHas('jobCosts', function($q) {
            $q->where('vendor_id', $this->counterpart_id);
        })
        ->latest()
        ->take(20)
        ->get()
        ->map(fn($s) => [
            'id' => $s->id,
            'awb' => $s->awb_number,
            'route' => $s->origin . ' → ' . $s->destination,
            'status' => $s->status,
            'service' => $s->service_type,
        ])
        ->toArray();
    }
    
    /**
     * Load unpaid bills for selected vendor
     */
    private function loadVendorBills()
    {
        if (!$this->counterpart_id) {
            $this->vendorBills = [];
            return;
        }
        
        $this->vendorBills = VendorBill::where('vendor_id', $this->counterpart_id)
            ->whereIn('status', ['unpaid', 'partial'])
            ->latest()
            ->get()
            ->map(fn($b) => [
                'id' => $b->id,
                'number' => $b->bill_number,
                'amount' => $b->remaining_amount,
                'due_date' => $b->due_date->format('d/m/Y'),
            ])
            ->toArray();
    }
    
    /**
     * Update journal preview
     */
    public function updatePreview()
    {
        if (!$this->amount || $this->amount <= 0) {
            $this->preview = null;
            $this->showPreview = false;
            return;
        }
        
        $data = [
            'transaction_date' => $this->transaction_date,
            'transaction_type' => $this->transaction_type,
            'counterpart_type' => $this->counterpart_type,
            'counterpart_name' => $this->counterpart_name,
            'customer_id' => $this->counterpart_type === 'customer' ? $this->counterpart_id : null,
            'vendor_id' => $this->counterpart_type === 'vendor' ? $this->counterpart_id : null,
            'shipment_id' => $this->shipment_id,
            'cost_category' => $this->cost_category,
            'amount' => $this->amount,
            'currency' => $this->currency,
            'exchange_rate' => $this->exchange_rate,
            'description' => $this->description,
        ];
        
        $this->preview = $this->cashierService->getAccountPairingPreview($data);
        $this->showPreview = true;
    }
    
    /**
     * Reset counterpart selection
     */
    private function resetCounterpart()
    {
        $this->counterpart_id = null;
        $this->counterpart_name = '';
        $this->shipment_id = null;
        $this->shipments = [];
        $this->invoices = [];
        $this->vendorBills = [];
        $this->invoice_id = null;
        $this->vendor_bill_id = null;
    }
    
    /**
     * Save transaction
     */
    public function save()
    {
        $this->validate([
            'transaction_date' => 'required|date',
            'transaction_type' => 'required|in:cash_in,cash_out',
            'counterpart_id' => 'required',
            'amount' => 'required|numeric|min:0.01',
            'description' => 'nullable|string|max:500',
            'attachment' => 'nullable|file|max:5120', // Max 5MB
        ]);
        
        $this->isSubmitting = true;
        
        try {
            $data = [
                'transaction_date' => $this->transaction_date,
                'transaction_type' => $this->transaction_type,
                'counterpart_type' => $this->counterpart_type,
                'counterpart_name' => $this->counterpart_name,
                'customer_id' => $this->counterpart_type === 'customer' ? $this->counterpart_id : null,
                'vendor_id' => $this->counterpart_type === 'vendor' ? $this->counterpart_id : null,
                'shipment_id' => $this->shipment_id,
                'cost_category' => $this->transaction_type === 'cash_out' ? $this->cost_category : null,
                'amount' => $this->amount,
                'currency' => $this->currency,
                'exchange_rate' => $this->exchange_rate,
                'description' => $this->description,
                'invoice_id' => $this->invoice_id,
                'vendor_bill_id' => $this->vendor_bill_id,
            ];
            
            $result = $this->cashierService->saveCashTransaction($data, $this->attachment);
            
            if ($result['success']) {
                session()->flash('success', 'Transaksi berhasil disimpan dan telah di-posting ke accounting!');
                $this->reset();
                $this->mount();
            } else {
                session()->flash('error', 'Gagal menyimpan transaksi: ' . $result['error']);
            }
            
        } catch (\Exception $e) {
            session()->flash('error', 'Terjadi kesalahan: ' . $e->getMessage());
        }
        
        $this->isSubmitting = false;
    }
    
    /**
     * Reset form
     */
    public function resetForm()
    {
        $this->reset();
        $this->mount();
    }
    
    public function render()
    {
        return view('livewire.admin.simple-cashier')
            ->layout('layouts.admin');
    }
}
