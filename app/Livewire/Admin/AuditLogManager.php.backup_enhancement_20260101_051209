<?php

namespace App\Livewire\Admin;

use Livewire\Component;
use Livewire\WithPagination;
use App\Models\ActivityLog;
use Illuminate\Support\Facades\Auth;

class AuditLogManager extends Component
{
    use WithPagination;
    
    public $search = '';
    public $filterUser = '';
    public $filterModule = '';
    public $filterAction = '';
    public $filterDateFrom = '';
    public $filterDateTo = '';
    public $perPage = 20;

    public function updatingSearch() { $this->resetPage(); }
    public function updatingFilterUser() { $this->resetPage(); }
    public function updatingFilterModule() { $this->resetPage(); }
    public function updatingFilterAction() { $this->resetPage(); }

    public function getStats()
    {
        return [
            'total' => ActivityLog::count(),
            'today' => ActivityLog::whereDate('created_at', today())->count(),
            'this_week' => ActivityLog::whereBetween('created_at', [now()->startOfWeek(), now()->endOfWeek()])->count(),
            'users_active' => ActivityLog::distinct('user_name')->count('user_name'),
            'creates' => ActivityLog::where('action', 'CREATE')->count(),
            'updates' => ActivityLog::where('action', 'like', '%UPDATE%')->count(),
            'deletes' => ActivityLog::where('action', 'DELETE')->count(),
        ];
    }

    public function getFilterOptions()
    {
        return [
            'users' => ActivityLog::distinct()->pluck('user_name')->filter()->sort()->values(),
            'modules' => ActivityLog::distinct()->pluck('module')->filter()->sort()->values(),
            'actions' => ActivityLog::distinct()->pluck('action')->filter()->sort()->values(),
        ];
    }

    public function render()
    {
        if (Auth::user()->role !== 'admin') abort(403);

        $query = ActivityLog::query();

        // Search
        if ($this->search) {
            $query->where(function($q) {
                $q->where('description', 'like', '%'.$this->search.'%')
                  ->orWhere('target_ref', 'like', '%'.$this->search.'%')
                  ->orWhere('user_name', 'like', '%'.$this->search.'%')
                  ->orWhere('module', 'like', '%'.$this->search.'%');
            });
        }

        // Filters
        if ($this->filterUser) {
            $query->where('user_name', $this->filterUser);
        }
        if ($this->filterModule) {
            $query->where('module', $this->filterModule);
        }
        if ($this->filterAction) {
            $query->where('action', $this->filterAction);
        }
        if ($this->filterDateFrom) {
            $query->whereDate('created_at', '>=', $this->filterDateFrom);
        }
        if ($this->filterDateTo) {
            $query->whereDate('created_at', '<=', $this->filterDateTo);
        }

        $logs = $query->latest()->paginate($this->perPage);
        $stats = $this->getStats();
        $filterOptions = $this->getFilterOptions();

        return view('livewire.admin.audit-log-manager', compact('logs', 'stats', 'filterOptions'))->layout('layouts.admin');
    }

    public function clearFilters()
    {
        $this->reset(['filterUser', 'filterModule', 'filterAction', 'filterDateFrom', 'filterDateTo']);
    }
}
