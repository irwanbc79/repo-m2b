<?php

namespace App\Livewire;

use Livewire\Component;
use Livewire\WithFileUploads;
use App\Models\FieldPhoto;
use App\Models\Shipment;
use App\Services\ImageProcessingService;
use Illuminate\Support\Facades\Auth;

class FieldPhotoUpload extends Component
{
    use WithFileUploads;

    public $shipmentNumber = '';
    public $shipmentId = null;
    public $shipment = null;
    public $photos = [];
    public $description = '';
    public $uploadProgress = 0;
    
    // Search dropdown
    public $searchQuery = '';
    public $searchResults = [];
    public $showDropdown = false;
    
    // GPS
    public $latitude = null;
    public $longitude = null;
    public $useGps = false;
    
    // QR Scanner
    public $showQrScanner = false;

    protected $listeners = [
        'qrCodeScanned',
        'gpsLocationReceived',
    ];

    protected function rules()
    {
        return [
            'shipmentId' => 'required|exists:shipments,id',
            'photos.*' => 'image|max:10240',
            'description' => 'nullable|string|max:500',
        ];
    }

    protected $messages = [
        'shipmentId.required' => 'Pilih shipment terlebih dahulu',
        'shipmentId.exists' => 'Shipment tidak ditemukan',
        'photos.*.image' => 'File harus berupa gambar',
        'photos.*.max' => 'Ukuran file maksimal 10MB',
    ];

    public function mount($shipment = null)
    {
        if ($shipment) {
            $this->searchQuery = $shipment;
            $this->loadShipmentByAwb($shipment);
        }
    }

    public function updatedSearchQuery()
    {
        if (strlen($this->searchQuery) >= 2) {
            $this->searchResults = Shipment::with('customer')
                ->where(function($query) {
                    $query->where('awb_number', 'LIKE', '%' . $this->searchQuery . '%')
                          ->orWhere('bl_number', 'LIKE', '%' . $this->searchQuery . '%')
                          ->orWhereHas('customer', function($q) {
                              // Gunakan company_name bukan name
                              $q->where('company_name', 'LIKE', '%' . $this->searchQuery . '%');
                          });
                })
                ->orderBy('created_at', 'desc')
                ->limit(10)
                ->get();
            $this->showDropdown = true;
        } else {
            $this->searchResults = [];
            $this->showDropdown = false;
        }
    }

    public function selectShipment($shipmentId)
    {
        $shipment = Shipment::with('customer')->find($shipmentId);
        
        if ($shipment) {
            $this->shipmentId = $shipment->id;
            $this->shipment = $shipment;
            $this->shipmentNumber = $shipment->awb_number;
            $this->searchQuery = $shipment->awb_number;
        }
        
        $this->showDropdown = false;
        $this->searchResults = [];
    }

    public function loadShipmentByAwb($awbNumber)
    {
        $shipment = Shipment::with('customer')
            ->where('awb_number', $awbNumber)
            ->orWhere('bl_number', $awbNumber)
            ->first();
        
        if ($shipment) {
            $this->shipmentId = $shipment->id;
            $this->shipment = $shipment;
            $this->shipmentNumber = $shipment->awb_number;
        }
    }

    public function updatedPhotos()
    {
        $this->validateOnly('photos.*');
    }

    public function removePhoto($index)
    {
        unset($this->photos[$index]);
        $this->photos = array_values($this->photos);
    }

    public function qrCodeScanned($result)
    {
        $this->showQrScanner = false;
        
        $shipment = Shipment::with('customer')
            ->where('awb_number', $result)
            ->orWhere('bl_number', $result)
            ->orWhere('id', $result)
            ->first();

        if ($shipment) {
            $this->selectShipment($shipment->id);
            
            $this->dispatch('notify', [
                'type' => 'success',
                'message' => 'Shipment ditemukan: ' . $shipment->awb_number
            ]);
        } else {
            $this->dispatch('notify', [
                'type' => 'error',
                'message' => 'Shipment tidak ditemukan'
            ]);
        }
    }

    public function gpsLocationReceived($lat, $lng)
    {
        $this->latitude = $lat;
        $this->longitude = $lng;
    }

    public function toggleGps()
    {
        $this->useGps = !$this->useGps;
        
        if ($this->useGps) {
            $this->dispatch('requestGpsLocation');
        } else {
            $this->latitude = null;
            $this->longitude = null;
        }
    }

    public function toggleQrScanner()
    {
        $this->showQrScanner = !$this->showQrScanner;
    }

    public function save()
    {
        $this->validate();

        if (empty($this->photos)) {
            $this->addError('photos', 'Pilih minimal 1 foto untuk diupload');
            return;
        }

        $imageService = app(ImageProcessingService::class);
        $savedCount = 0;

        foreach ($this->photos as $index => $photo) {
            $this->uploadProgress = round((($index + 1) / count($this->photos)) * 100);
            
            try {
                $processed = $imageService->processUpload(
                    $photo,
                    $this->shipmentId,
                    Auth::id()
                );

                FieldPhoto::create([
                    'shipment_id' => $this->shipmentId,
                    'user_id' => Auth::id(),
                    'original_filename' => $photo->getClientOriginalName(),
                    'file_path' => $processed['path'],
                    'thumbnail_path' => $processed['thumbnail_path'],
                    'file_size' => $processed['size'],
                    'mime_type' => $processed['mime_type'],
                    'width' => $processed['width'],
                    'height' => $processed['height'],
                    'description' => $this->description,
                    'upload_ip' => request()->ip(),
                    'latitude' => $this->latitude,
                    'longitude' => $this->longitude,
                    'status' => 'approved',
                ]);

                $savedCount++;
            } catch (\Exception $e) {
                \Log::error('Photo upload failed', [
                    'error' => $e->getMessage(),
                    'file' => $photo->getClientOriginalName()
                ]);
            }
        }

        $this->uploadProgress = 0;
        $this->photos = [];
        $this->description = '';

        session()->flash('message', "Berhasil mengupload {$savedCount} foto!");
        
        return redirect()->route('admin.field-docs.gallery', [
            'shipment' => $this->shipmentNumber
        ]);
    }

    public function render()
    {
        return view('livewire.field-photo-upload');
    }
}
