<?php

namespace App\Livewire;

use Livewire\Component;
use Livewire\WithFileUploads;
use App\Models\FieldPhoto;
use App\Models\Shipment;
use App\Services\ImageProcessingService;
use Illuminate\Support\Facades\Auth;

class FieldPhotoUpload extends Component
{
    use WithFileUploads;

    public $shipmentNumber = '';
    public $shipmentId = null;
    public $shipment = null;
    public $photos = [];
    public $description = '';
    public $uploadProgress = 0;
    
    public $latitude = null;
    public $longitude = null;
    public $useGps = false;
    
    public $showQrScanner = false;

    protected $listeners = [
        'qrCodeScanned',
        'gpsLocationReceived',
    ];

    protected $rules = [
        'shipmentNumber' => 'required|exists:shipments,shipment_number',
        'photos.*' => 'image|max:10240',
        'description' => 'nullable|string|max:500',
    ];

    protected $messages = [
        'shipmentNumber.required' => 'Nomor shipment harus diisi',
        'shipmentNumber.exists' => 'Nomor shipment tidak ditemukan',
        'photos.*.image' => 'File harus berupa gambar',
        'photos.*.max' => 'Ukuran file maksimal 10MB',
    ];

    public function mount($shipment = null)
    {
        if ($shipment) {
            $this->shipmentNumber = $shipment;
            $this->loadShipment();
        }
    }

    public function updatedShipmentNumber()
    {
        $this->loadShipment();
    }

    public function loadShipment()
    {
        if ($this->shipmentNumber) {
            $this->shipment = Shipment::with('customer')
                ->where('shipment_number', $this->shipmentNumber)
                ->first();
            
            if ($this->shipment) {
                $this->shipmentId = $this->shipment->id;
            }
        }
    }

    public function updatedPhotos()
    {
        $this->validateOnly('photos.*');
    }

    public function removePhoto($index)
    {
        unset($this->photos[$index]);
        $this->photos = array_values($this->photos);
    }

    public function qrCodeScanned($result)
    {
        $this->showQrScanner = false;
        
        $shipment = Shipment::where('shipment_number', $result)
            ->orWhere('id', $result)
            ->first();

        if ($shipment) {
            $this->shipmentNumber = $shipment->shipment_number;
            $this->loadShipment();
            
            $this->dispatch('notify', [
                'type' => 'success',
                'message' => 'Shipment ditemukan: ' . $shipment->shipment_number
            ]);
        } else {
            $this->dispatch('notify', [
                'type' => 'error',
                'message' => 'Shipment tidak ditemukan'
            ]);
        }
    }

    public function gpsLocationReceived($lat, $lng)
    {
        $this->latitude = $lat;
        $this->longitude = $lng;
    }

    public function toggleGps()
    {
        $this->useGps = !$this->useGps;
        
        if ($this->useGps) {
            $this->dispatch('requestGpsLocation');
        } else {
            $this->latitude = null;
            $this->longitude = null;
        }
    }

    public function toggleQrScanner()
    {
        $this->showQrScanner = !$this->showQrScanner;
    }

    public function save()
    {
        $this->validate();

        if (empty($this->photos)) {
            $this->addError('photos', 'Pilih minimal 1 foto untuk diupload');
            return;
        }

        $imageService = app(ImageProcessingService::class);
        $savedCount = 0;

        foreach ($this->photos as $index => $photo) {
            $this->uploadProgress = round((($index + 1) / count($this->photos)) * 100);
            
            try {
                $processed = $imageService->processUpload(
                    $photo,
                    $this->shipmentId,
                    Auth::id()
                );

                FieldPhoto::create([
                    'shipment_id' => $this->shipmentId,
                    'user_id' => Auth::id(),
                    'original_filename' => $photo->getClientOriginalName(),
                    'file_path' => $processed['path'],
                    'thumbnail_path' => $processed['thumbnail_path'],
                    'file_size' => $processed['size'],
                    'mime_type' => $processed['mime_type'],
                    'width' => $processed['width'],
                    'height' => $processed['height'],
                    'description' => $this->description,
                    'upload_ip' => request()->ip(),
                    'latitude' => $this->latitude,
                    'longitude' => $this->longitude,
                    'status' => 'approved',
                ]);

                $savedCount++;
            } catch (\Exception $e) {
                \Log::error('Photo upload failed', [
                    'error' => $e->getMessage(),
                    'file' => $photo->getClientOriginalName()
                ]);
            }
        }

        $this->uploadProgress = 0;
        $this->photos = [];
        $this->description = '';

        session()->flash('message', "Berhasil mengupload {$savedCount} foto!");
        
        return redirect()->route('field-documentation.gallery', [
            'shipment' => $this->shipmentNumber
        ]);
    }

    public function render()
    {
        return view('livewire.field-photo-upload');
    }
}
