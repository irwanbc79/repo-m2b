<?php

namespace App\Livewire\HsCode;

use Livewire\Component;
use Livewire\WithPagination;
use Livewire\Attributes\Layout;
use Illuminate\Support\Facades\DB;

#[Layout('layouts.admin')]
class Explorer extends Component
{
    use WithPagination;

    public $search = '';
    public $selectedChapter = '';
    
    protected $queryString = [
        'search' => ['except' => ''],
        'selectedChapter' => ['except' => '']
    ];

    public function updatingSearch()
    {
        $this->resetPage();
    }

    public function updatingSelectedChapter()
    {
        $this->resetPage();
    }

    public function render()
    {
        $chapters = DB::table('hs_chapters')
            ->orderBy('chapter_number')
            ->get();

        $query = DB::table('hs_codes')
            ->select('hs_code', 'description_id', 'hs_level', 'chapter_number');

        if (!empty($this->search)) {
            $query->where(function($q) {
                $q->where('hs_code', 'LIKE', '%' . $this->search . '%')
                  ->orWhere('description_id', 'LIKE', '%' . $this->search . '%');
            });
        }

        if (!empty($this->selectedChapter)) {
            $query->where('chapter_number', $this->selectedChapter);
        }

        $results = $query->orderBy('hs_code')->paginate(20);

        return view('livewire.hs-code.explorer-styled', [
            'chapters' => $chapters,
            'results' => $results
        ]);
    }
}
