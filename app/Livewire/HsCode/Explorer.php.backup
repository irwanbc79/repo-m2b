<?php

namespace App\Livewire\HsCode;

use Livewire\Component;
use Livewire\WithPagination;
use Illuminate\Support\Facades\DB;

class Explorer extends Component
{
    use WithPagination;

    public $search = '';
    public $selectedChapter = '';
    public $selectedLevel = '';
    public $viewMode = 'search'; // 'search', 'browse', 'detail'
    public $selectedCode = null;
    public $codeHierarchy = [];

    protected $queryString = [
        'search' => ['except' => ''],
        'selectedChapter' => ['except' => ''],
        'viewMode' => ['except' => 'search']
    ];

    public function updatingSearch()
    {
        $this->resetPage();
    }

    public function updatingSelectedChapter()
    {
        $this->resetPage();
    }

    public function selectCode($hsCode)
    {
        $this->selectedCode = DB::table('hs_codes')
            ->where('hs_code', $hsCode)
            ->first();

        if ($this->selectedCode) {
            // Get hierarchy (parents)
            $this->codeHierarchy = $this->getHierarchy($this->selectedCode);
            $this->viewMode = 'detail';
        }
    }

    private function getHierarchy($code)
    {
        $hierarchy = [];
        $current = $code;

        // Add current code
        $hierarchy[] = $current;

        // Traverse up to parents
        while ($current->parent_code) {
            $parent = DB::table('hs_codes')
                ->where('hs_code', $current->parent_code)
                ->first();

            if ($parent) {
                array_unshift($hierarchy, $parent);
                $current = $parent;
            } else {
                break;
            }
        }

        return $hierarchy;
    }

    public function getChildrenProperty()
    {
        if (!$this->selectedCode) {
            return collect();
        }

        return DB::table('hs_codes')
            ->where('parent_code', $this->selectedCode->hs_code)
            ->orderBy('hs_code')
            ->get();
    }

    public function backToSearch()
    {
        $this->viewMode = 'search';
        $this->selectedCode = null;
        $this->codeHierarchy = [];
    }

    public function switchToBrowse()
    {
        $this->viewMode = 'browse';
    }

    public function switchToSearch()
    {
        $this->viewMode = 'search';
    }

    public function render()
    {
        $chapters = DB::table('hs_chapters')
            ->orderBy('chapter_number')
            ->get();

        $results = collect();

        if ($this->viewMode === 'search' && !empty($this->search)) {
            $results = DB::table('hs_codes')
                ->where(function($query) {
                    $query->where('hs_code', 'LIKE', '%' . $this->search . '%')
                          ->orWhere('description_id', 'LIKE', '%' . $this->search . '%');
                })
                ->orderBy('hs_code')
                ->paginate(20);
        } elseif ($this->viewMode === 'browse' && !empty($this->selectedChapter)) {
            $results = DB::table('hs_codes')
                ->where('chapter_number', $this->selectedChapter)
                ->when($this->selectedLevel, function($query) {
                    $query->where('hs_level', $this->selectedLevel);
                })
                ->orderBy('hs_code')
                ->paginate(50);
        }

        return view('livewire.hs-code.explorer', [
            'chapters' => $chapters,
            'results' => $results
        ]);
    }
}
