<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;

class Shipment extends Model
{
    use HasFactory;

    protected $fillable = [
        'customer_id',
        'quotation_id',
        'awb_number',
        'bl_number',
        'shipment_type',
        'container_mode',
        'container_info',
        'service_type',
        'status',
        'origin',
        'destination',
        'cancelled_at',
        'cancelled_by',
        'cancellation_reason',
    ];

    protected $casts = [
        'cancelled_at' => 'datetime',
    ];

    // Status constants
    const STATUS_PENDING = 'pending';
    const STATUS_IN_PROGRESS = 'in_progress';
    const STATUS_COMPLETED = 'completed';
    const STATUS_CANCEL = 'cancel';

    /**
     * Get all available statuses
     */
    public static function getStatuses(): array
    {
        return [
            self::STATUS_PENDING => 'â³ Belum Ada',
            self::STATUS_IN_PROGRESS => 'ğŸ”„ Progress',
            self::STATUS_COMPLETED => 'âœ… Completed',
            self::STATUS_CANCEL => 'âŒ Dibatalkan',
        ];
    }

    /**
     * Get status badge HTML
     */
    public function getStatusBadgeAttribute(): string
    {
        $badges = [
            self::STATUS_PENDING => '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">â³ Belum Ada</span>',
            self::STATUS_IN_PROGRESS => '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">ğŸ”„ Progress</span>',
            self::STATUS_COMPLETED => '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">âœ… Completed</span>',
            self::STATUS_CANCEL => '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">âŒ Dibatalkan</span>',
        ];

        return $badges[$this->status] ?? $this->status;
    }

    /**
     * Get status emoji
     */
    public function getStatusEmojiAttribute(): string
    {
        $emojis = [
            self::STATUS_PENDING => 'â³',
            self::STATUS_IN_PROGRESS => 'ğŸ”„',
            self::STATUS_COMPLETED => 'âœ…',
            self::STATUS_CANCEL => 'âŒ',
        ];

        return $emojis[$this->status] ?? 'ğŸ“¦';
    }

    /**
     * Check if shipment is cancelled
     */
    public function isCancelled(): bool
    {
        return $this->status === self::STATUS_CANCEL;
    }

    /**
     * Check if shipment can be edited
     */
    public function canBeEdited(): bool
    {
        return !$this->isCancelled();
    }

    /**
     * Cancel this shipment
     */
    public function cancel(int $userId, ?string $reason = null): void
    {
        $this->update([
            'status' => self::STATUS_CANCEL,
            'cancelled_at' => now(),
            'cancelled_by' => $userId,
            'cancellation_reason' => $reason,
        ]);
    }

    /**
     * Relationships
     */
    public function customer(): BelongsTo
    {
        return $this->belongsTo(Customer::class);
    }

    public function quotation(): BelongsTo
    {
        return $this->belongsTo(Quotation::class);
    }

    public function cancelledBy(): BelongsTo
    {
        return $this->belongsTo(User::class, 'cancelled_by');
    }

    public function fieldPhotos(): HasMany
    {
        return $this->hasMany(FieldPhoto::class);
    }

    /**
     * Documents relationship (jika tabel documents ada)
     * Jika belum ada tabel documents, relationship ini akan return empty collection
     */
    public function documents(): HasMany
    {
        // Cek apakah ada model ShipmentDocument
        if (class_exists(\App\Models\ShipmentDocument::class)) {
            return $this->hasMany(\App\Models\ShipmentDocument::class);
        }
        
        // Return empty collection jika tidak ada
        return new \Illuminate\Database\Eloquent\Relations\HasMany(
            (new static)->newQuery(),
            $this,
            'shipment_id',
            'id'
        );
    }

    /**
     * Scopes
     */
    public function scopeActive($query)
    {
        return $query->where('status', '!=', self::STATUS_CANCEL);
    }

    public function scopeCancelled($query)
    {
        return $query->where('status', self::STATUS_CANCEL);
    }

    public function scopeByStatus($query, string $status)
    {
        return $query->where('status', $status);
    }
}
