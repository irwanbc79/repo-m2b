<?php

namespace App\Services;

use Intervention\Image\ImageManager;
use Intervention\Image\Drivers\Gd\Driver;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class ImageProcessingService
{
    protected $maxWidth = 1920;
    protected $maxHeight = 1920;
    protected $quality = 80;
    protected $thumbnailSize = 400;
    protected ImageManager $manager;

    public function __construct()
    {
        // Intervention Image v3.x menggunakan ImageManager dengan Driver
        $this->manager = new ImageManager(new Driver());
    }

    public function processUpload($file, $shipmentId, $userId)
    {
        // Generate unique filename
        $extension = strtolower($file->getClientOriginalExtension());
        
        // Handle HEIC/HEIF - convert to jpg
        if (in_array($extension, ['heic', 'heif'])) {
            $extension = 'jpg';
        }
        
        $filename = time() . '_' . Str::random(10) . '.' . $extension;
        $thumbnailFilename = 'thumb_' . $filename;

        // Paths - organized by year/month
        $directory = "field-photos/" . date('Y/m') . "/{$shipmentId}";
        $path = "{$directory}/{$filename}";
        $thumbnailPath = "{$directory}/thumbnails/{$thumbnailFilename}";

        // Create directories
        Storage::disk('public')->makeDirectory($directory);
        Storage::disk('public')->makeDirectory("{$directory}/thumbnails");

        try {
            // Load image using v3.x API
            $image = $this->manager->read($file->getRealPath());
            
            $originalWidth = $image->width();
            $originalHeight = $image->height();

            // Resize if needed (scale down, maintain aspect ratio)
            if ($originalWidth > $this->maxWidth || $originalHeight > $this->maxHeight) {
                $image->scaleDown(width: $this->maxWidth, height: $this->maxHeight);
            }

            // Add watermark
            $this->addWatermark($image, $shipmentId);

            // Encode and save main image
            $encoded = $image->toJpeg($this->quality);
            Storage::disk('public')->put($path, (string) $encoded);

            // Create thumbnail - load fresh image for thumbnail
            $thumbnail = $this->manager->read($file->getRealPath());
            $thumbnail->cover($this->thumbnailSize, $this->thumbnailSize);
            $thumbnailEncoded = $thumbnail->toJpeg(75);
            Storage::disk('public')->put($thumbnailPath, (string) $thumbnailEncoded);

            return [
                'path' => $path,
                'thumbnail_path' => $thumbnailPath,
                'width' => $image->width(),
                'height' => $image->height(),
                'size' => Storage::disk('public')->size($path),
                'mime_type' => 'image/jpeg'
            ];
            
        } catch (\Exception $e) {
            \Log::error('Image processing failed', [
                'error' => $e->getMessage(),
                'file' => $file->getClientOriginalName(),
                'shipment_id' => $shipmentId
            ]);
            
            // Fallback: store original without processing
            $path = $file->storeAs($directory, $filename, 'public');
            
            return [
                'path' => $path,
                'thumbnail_path' => $path,
                'width' => null,
                'height' => null,
                'size' => $file->getSize(),
                'mime_type' => $file->getMimeType()
            ];
        }
    }

    protected function addWatermark($image, $shipmentId)
    {
        $watermarkText = "SHP-{$shipmentId} | " . now()->format('d/m/Y H:i');
        
        // v3.x text method - position at bottom left
        $image->text($watermarkText, 20, $image->height() - 20, function($font) {
            $font->size(18);
            $font->color('rgba(255, 255, 255, 0.8)');
        });
    }

    public function deletePhoto($fieldPhoto)
    {
        try {
            if ($fieldPhoto->file_path) {
                Storage::disk('public')->delete($fieldPhoto->file_path);
            }
            
            if ($fieldPhoto->thumbnail_path) {
                Storage::disk('public')->delete($fieldPhoto->thumbnail_path);
            }
            
            return true;
        } catch (\Exception $e) {
            \Log::error('Failed to delete photo', [
                'error' => $e->getMessage(),
                'photo_id' => $fieldPhoto->id
            ]);
            return false;
        }
    }
}
